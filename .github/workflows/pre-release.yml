name: Pre-release

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: pre-release-${{ github.event.pull_request.head.ref }}
  cancel-in-progress: true

jobs:
  # Run CI workflow first
  ci:
    name: Run CI
    uses: ./.github/workflows/ci.yml
    permissions:
      contents: read

  pre-release:
    name: Create Pre-release
    runs-on: ubuntu-latest
    needs: ci
    if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Download build artifact
        uses: actions/download-artifact@v5
        with:
          name: build-${{ github.sha }}
          path: .
          if-no-files-found: error

      - name: Get PR number and short SHA
        id: pr_info
        run: |
          set -euo pipefail
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "short_sha=$(git rev-parse --short ${{ github.event.pull_request.head.sha }})" >> $GITHUB_OUTPUT
          echo "branch_name=${{ github.head_ref }}" >> $GITHUB_OUTPUT

      - name: Create pre-release tag
        id: create_tag
        run: |
          set -euo pipefail
          # Use the PR branch name as the pre-release tag, sanitized for Git tags
          BRANCH_RAW="${{ steps.pr_info.outputs.branch_name }}"
          TAG_NAME=$(echo "$BRANCH_RAW" \
            | tr '[:upper:]' '[:lower:]' \
            | sed -E 's|[^a-z0-9._-]+|-|g' \
            | sed -E 's|-{2,}|-|g; s|^[-.]+||; s|[-.]+$||')
          if [ -z "$TAG_NAME" ]; then TAG_NAME="pr-${{ steps.pr_info.outputs.pr_number }}"; fi
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

          # Delete existing tag if it exists (for synchronize events)
          git tag -d $TAG_NAME 2>/dev/null || true
          git push origin :refs/tags/$TAG_NAME 2>/dev/null || true

          # Create new tag
          git tag $TAG_NAME
          git push origin $TAG_NAME

      - name: Ensure single pre-release for this branch
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          # If a release exists for this tag (branch), delete it so we can recreate fresh
          if gh release view "${{ steps.create_tag.outputs.tag_name }}" >/dev/null 2>&1; then
            gh release delete "${{ steps.create_tag.outputs.tag_name }}" --yes || true
          fi

      - name: Create GitHub Pre-release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          gh release create ${{ steps.create_tag.outputs.tag_name }} \
            --title "Pre-release: PR #${{ steps.pr_info.outputs.pr_number }} (${{ steps.pr_info.outputs.branch_name }})" \
            --notes "**Pre-release build for testing**

          This is an automated pre-release for PR #${{ steps.pr_info.outputs.pr_number }}.

          **Branch:** \`${{ steps.pr_info.outputs.branch_name }}\`
          **Commit:** ${{ github.event.pull_request.head.sha }}
          **PR:** ${{ github.event.pull_request.html_url }}

          ## Testing this pre-release

          Update your MCP configuration to use this pre-release:

          \`\`\`json
          {
            \"servers\": {
              \"bmad\": {
                \"command\": \"npx\",
                \"args\": [\"-y\", \"git+https://github.com/${{ github.repository }}#${{ steps.create_tag.outputs.tag_name }}\"]
              }
            }
          }
          \`\`\`

          Or for local testing:
          \`\`\`bash
          git fetch --tags --force
          git checkout --detach tags/${{ steps.create_tag.outputs.tag_name }}
          npm install
          npm run build
          \`\`\`

          **‚ö†Ô∏è This is a pre-release and will be deleted when the PR is merged or closed.**" \
            --prerelease

      - name: Comment on PR
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.pr_info.outputs.pr_number }};
            const tagName = '${{ steps.create_tag.outputs.tag_name }}';
            const releaseUrl = `https://github.com/${{ github.repository }}/releases/tag/${tagName}`;
            const uniqueMarker = '<!-- bmad-pre-release -->';

            // List comments on the PR
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            // Only match comments created by GitHub Actions and containing our unique marker
            const botComment = comments.data.find(comment =>
              comment.user &&
              comment.user.type === 'Bot' &&
              comment.user.login === 'github-actions[bot]' &&
              comment.body && comment.body.includes(uniqueMarker)
            );

            const commentBody = `${uniqueMarker}
            ## üöÄ Pre-release created

            A pre-release has been created for testing: [${tagName}](${releaseUrl})

            ### Test this PR on another machine:

            **Option 1: Using npx (recommended)**
            Update your MCP configuration:
            \`\`\`json
            {
              \"servers\": {
                \"bmad\": {
                  \"command\": \"npx\",
                  \"args\": [\"-y\", \"git+https://github.com/${{ github.repository }}#${tagName}\"]
                }
              }
            }
            \`\`\`

            **Option 2: Clone and test locally**
            \`\`\`bash
            git clone https://github.com/${{ github.repository }}.git
            cd bmad-mcp-server
            git fetch --tags --force
            git checkout --detach tags/${tagName}
            npm install
            npm run build
            \`\`\`

            ---
            *Pre-release will be automatically cleaned up when PR is merged or closed.*`;

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody,
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody,
              });
            }
