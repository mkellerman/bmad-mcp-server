# Test Suite: Comprehensive Error Handling
# Validates error handling for all types of invalid commands and scenarios

test_suite: 'Comprehensive Error Handling Tests'
description: 'Validate graceful error handling for invalid commands, missing resources, and edge cases'

config:
  llm_model: 'gpt-4.1'
  temperature: 0.1
  timeout: 20000
  judge_model: 'gpt-4.1'
  judge_threshold: 0.7

tests:
  - id: 'error-comp-001'
    name: 'Invalid agent name - not found'
    prompt: |
      You have access to a BMAD MCP tool.

      User: "Load the nonexistent-agent from BMAD"

      Call bmad with command "nonexistent-agent"

    expectations:
      - type: 'contains'
        value: 'does not exist'
        case_sensitive: false
        description: 'Should indicate agent not found or does not exist'

      - type: 'not_contains'
        value: 'stack trace'
        case_sensitive: false
        description: 'Should not show stack traces'

      - type: 'response_length'
        min: 20
        max: 2000
        description: 'Should provide error feedback'

  - id: 'error-comp-002'
    name: 'Invalid workflow name'
    prompt: |
      You have access to a BMAD MCP tool.

      User: "Execute the missing-workflow"

      Call bmad with command "*missing-workflow"

    expectations:
      - type: 'contains'
        value: 'missing-workflow'
        case_sensitive: false
        description: 'Should reference the workflow name in error'

      - type: 'not_contains'
        value: 'undefined'
        case_sensitive: false
        description: 'Should not have undefined values'

  - id: 'error-comp-003'
    name: 'Malformed command with special characters'
    prompt: |
      User provides malformed input.

      Call bmad with command "agent@#$%invalid"

    expectations:
      - type: 'response_length'
        min: 10
        max: 2000
        description: 'Should handle gracefully'

      - type: 'not_contains'
        value: 'exception'
        case_sensitive: false
        description: 'Should not throw exceptions'

  - id: 'error-comp-004'
    name: 'Command with dangerous characters'
    prompt: |
      User accidentally includes path traversal attempt.

      Call bmad with command "../../../etc/passwd"

    expectations:
      - type: 'response_length'
        min: 10
        max: 2000
        description: 'Should reject dangerous input'

      - type: 'not_contains'
        value: 'passwd'
        case_sensitive: false
        description: 'Should not expose system files'

  - id: 'error-comp-005'
    name: 'Very long command input'
    prompt: |
      User provides extremely long command.

      Call bmad with command "agent-with-very-long-name-that-exceeds-reasonable-limits-and-should-be-rejected-because-its-too-long"

    expectations:
      - type: 'response_length'
        min: 10
        max: 2000
        description: 'Should handle long input'

  - id: 'error-comp-006'
    name: 'Command with whitespace only'
    prompt: |
      User accidentally sends whitespace.

      Call bmad with command "   " (spaces only)

    expectations:
      - type: 'response_length'
        min: 20
        max: 5000
        description: 'Should handle whitespace gracefully'

  - id: 'error-comp-007'
    name: 'Null byte injection attempt'
    prompt: |
      User input contains null bytes.

      Call bmad with command "agent\u0000test"

    expectations:
      - type: 'response_length'
        min: 10
        max: 2000
        description: 'Should reject null bytes'

  - id: 'error-comp-008'
    name: 'Mixed valid and invalid characters'
    prompt: |
      User command has mixed valid/invalid chars.

      Call bmad with command "analyst<script>alert()</script>"

    expectations:
      - type: 'response_length'
        min: 10
        max: 2000
        description: 'Should handle malformed input'

      - type: 'contains'
        value: 'invalid'
        case_sensitive: false
        description: 'Should indicate invalid characters detected'

  - id: 'error-comp-009'
    name: 'Agent name with invalid prefix'
    prompt: |
      User tries to load agent with wrong prefix.

      Call bmad with command "*analyst" (asterisk should be for workflows only)

    expectations:
      - type: 'response_length'
        min: 10
        max: 2000
        description: 'Should handle prefix confusion'

  - id: 'error-comp-010'
    name: 'Workflow without asterisk prefix'
    prompt: |
      User forgets asterisk for workflow.

      Call bmad with command "party-mode" (missing asterisk)

    expectations:
      - type: 'response_length'
        min: 10
        max: 2000
        description: 'Should provide guidance'

  - id: 'error-comp-011'
    name: 'Double asterisk prefix'
    prompt: |
      User adds double asterisk.

      Call bmad with command "**party-mode"

    expectations:
      - type: 'response_length'
        min: 10
        max: 2000
        description: 'Should handle malformed prefix'

  - id: 'error-comp-012'
    name: 'Unicode characters in command'
    prompt: |
      User includes unicode in command.

      Call bmad with command "анализатор" (Cyrillic for "analyst")

    expectations:
      - type: 'response_length'
        min: 10
        max: 2000
        description: 'Should handle unicode gracefully'

  - id: 'error-comp-013'
    name: 'Empty module prefix'
    prompt: |
      User provides empty module prefix.

      Call bmad with command "/analyst" (empty module before slash)

    expectations:
      - type: 'response_length'
        min: 10
        max: 2000
        description: 'Should reject empty module prefix'

  - id: 'error-comp-014'
    name: 'Multiple slashes in qualified name'
    prompt: |
      User uses multiple slashes.

      Call bmad with command "core/module/analyst"

    expectations:
      - type: 'response_length'
        min: 10
        max: 2000
        description: 'Should handle invalid path format'

  - id: 'error-comp-015'
    name: 'Case sensitivity validation'
    prompt: |
      Test case sensitivity.

      Call bmad with command "BMAD-MASTER" (uppercase)

    expectations:
      - type: 'response_length'
        min: 20
        max: 5000
        description: 'Should be case insensitive or provide guidance'
